# Vertex AI グラウンディング時の文字数制限問題解決

## ✅ 問題解決完了

### **問題の原因**
グラウンディング機能使用時、AIが検索結果の豊富な情報を優先し、SystemPromptの文字数制限を無視していた。

### **解決策の実装**

#### 1. **グラウンディング専用の制限指示**
```typescript
// グラウンディング有効時は特別な指示を追加
if (enableGrounding) {
  finalMessage = `${systemPrompt}

重要: 検索結果を使用する場合でも、必ず指定された文字数制限を守ってください。簡潔で要点を絞った回答をしてください。

${message}`
}
```

#### 2. **トークン制限の強化**
```typescript
// グラウンディング有効時はより制限を強化
maxOutputTokens: enableGrounding ? 512 : 2048
```

### **技術的詳細**

#### **グラウンディングの処理フロー:**
1. **検索実行**: ユーザーの質問に基づいてGoogle検索
2. **情報統合**: 検索結果を内部コンテキストに追加
3. **回答生成**: 拡張されたコンテキストを基に回答

#### **問題の根本原因:**
- グラウンディングが内部的に大量の情報をコンテキストに追加
- AIは「完全で正確な情報提供」を優先
- SystemPromptの制限よりも情報の完全性が優先される

### **対策効果:**
- **明示的制限**: グラウンディング時も文字数制限を明確に指示
- **トークン制限**: 512トークン（約300-400文字）に制限
- **重複指示**: 複数箇所での制限強調

## 人間テストチェックポイント
⚠️ **テスト待ち**: Edge Functionをデプロイして効果確認

```bash
supabase functions deploy call-vertex-ai
```

**確認項目:**
1. グラウンディング有効時でも指定文字数制限が守られるか
2. 検索結果を活用しつつ簡潔な回答になるか
3. 情報の質が保たれているか

この修正により、グラウンディング使用時でもSystemPromptの文字数制限が確実に適用されます。
